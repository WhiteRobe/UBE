function gameInit(){if(gp_store.state.debug)console.log('游戏初始化...');inventory.commit('rstInventory');gp_store.dispatch('rstParams');for(var w of wildernessSet)w.resetArea();gameReadyToStart();}function gameRestart(){if(gp_store.state.debug)console.log('重启完毕...');gameInit()}function gameReadyToStart(){app.$Message.config({top:120,duration:3});success(app,'资源载入完毕, 游戏可以开始!')}function gameStart(){gp_store.commit('setGamePhase',GAMEPHASE.MAP);}function gameEnd(isWin){gp_store.commit('setGamePhase',GAMEPHASE.GAME_END);gameRouter.push('/main/end')}function roll(){return parseInt((Math.random()*6)+1)}function cleanAllEvent(){for(let w of wildernessSet)w.events=new Array()}function eventHappend(){cleanAllEvent();var rolls=[roll(),roll(),roll(),roll()];let index=0;for(let r of rolls)for(let w of wildernessSet)if(r==w.num)w.events.push(EVENT_LIST[index++])}function search(result){let wilderness=gp_store.state.viewWilderness.wilderness;if(result==0){gp_store.commit('incPerfectSearchSum',1);gp_store.commit('incGodsHand',5);let construct=wilderness.construct;inventory.dispatch('findItem',construct);gp_store.dispatch('chargeItem',construct);success(app,'找到一个已充能装置['+construct+']及获得5点上帝之手能量!');return endSearch()}else if(1<=result&&result<=10){let construct=wilderness.construct;if(isConstructOwned(construct)){let component=wilderness.component;inventory.dispatch('findItem',component);inventory.dispatch('findItem',component);success(app,'装置['+construct+']已拥有，改为获得2个['+component+']组件!')}else{inventory.dispatch('findItem',construct);success(app,'获得装置['+construct+']!')}return endSearch()}else if(11<=result&&result<=99){let component=wilderness.component;inventory.dispatch('findItem',component);success(app,'获得一个组件'+component+'!');return endSearch()}else{let monster=wilderness.pickMonster(result);gp_store.commit('viewBattle/setMonster',monster);return encounter()}}function encounter(){gp_store.commit('setGamePhase',GAMEPHASE.BATTLE);gameRouter.push('/main/wilderness/battle')}function combat(dice1,dice2){let wilderness=gp_store.state.viewWilderness.wilderness;let monster=gp_store.state.viewBattle.monster;var healthLoss=(monster.isATK(dice1)?1:0)+(monster.isATK(dice2)?1:0);gp_store.commit('incHealth',0-healthLoss);if(healthLoss!=0)error(app,'损失生命'+healthLoss+'!');let monsterDied=false;if(monster.isHIT(dice1)||monster.isHIT(dice2)){if(monster.isKing()){console.log('gohere 1-2-1');let treasure=wilderness.treasure;inventory.dispatch('findItem',treasure);success(app,'击败首领, 获得宝物['+treasure+']!')}else{let victoryNum=roll();let component=wilderness.component;if(victoryNum>=monster.level){inventory.dispatch('findItem',component);success(app,'击败怪物, 获得组件['+component+']!');if(gp_store.state.debug)console.log('掷点数:'+victoryNum+'. 取得组件:'+component+'!')}else{if(gp_store.state.debug)console.log('掷点数:'+victoryNum+'. 未取得组件:'+component+'!')}}monsterDied=true}if(gp_store.state.health<0)return gameEnd(false);else if(gp_store.state.health==0){goBackWorkShop();recoverFromUnconsciousness()}else{if(monsterDied)return endBattle();else{if(healthLoss==0)info(app,'新一轮的战斗开始了!');gp_store.commit('viewBattle/rstDice');gp_store.commit('viewBattle/setToolWandUsed',false);}}}function endBattle(){gp_store.commit('setGamePhase',GAMEPHASE.WILDERNESS);gameRouter.push('/main/wilderness');gp_store.commit('viewBattle/rstParams',false);endSearch()}function endSearch(){let wilderness=gp_store.state.viewWilderness.wilderness;wilderness.addStep();gp_store.commit('viewWilderness/setBeginSearch',false);gp_store.commit('viewWilderness/rstDiceBox');gp_store.commit('viewWilderness/rstDice');}function gotoWilderness(wilderness){gp_store.commit('viewWilderness/setWilderness',wilderness);gp_store.commit('setGamePhase',GAMEPHASE.WILDERNESS);gameRouter.push('/main/wilderness')}function gotoMap(){gp_store.commit('setGamePhase',GAMEPHASE.MAP);gameRouter.push('/main/map')}function gotoWorkShop(){gp_store.commit('setGamePhase',GAMEPHASE.WORKSHOP);gameRouter.push('/main/workshop')}function goBackMap(){var wilderness=gp_store.state.viewWilderness.wilderness;wilderness.step=0;gp_store.commit('viewWilderness/rstParams');gp_store.commit('viewBattle/rstParams');gotoMap();success(app,'已返回冒险地图')}function goBackWorkShop(){var wilderness=gp_store.state.viewWilderness.wilderness;wilderness.step=0;gp_store.commit('viewWilderness/rstParams');gp_store.commit('viewBattle/rstParams');gotoWorkShop();success(app,'已返回工作室')}function recoverFromUnconsciousness(){gp_store.commit('rstHealth');let adjustEffectText='';let dayPassed=6;if(gp_store.state.charge_con_gate){dayPassed=4;adjustEffectText='由于'+CONSTRUCT_NAME[5]+'的效果,'}safelyChangeDay(dayPassed);warning(app,adjustEffectText+'你昏迷了'+dayPassed+'天');}function restInWorkshop(){if(gp_store.state.health+1>6)warning(app,'现在不是休息的时候!');else{gp_store.commit('incHealth',1);safelyChangeDay(1);success(app,'休息1天:生命值+1!')}}function nextDay(){if(calendar[gp_store.state.today]==1)eventHappend();gp_store.commit('incToday',1);if(inventory.state.tre_scale){gp_store.commit('incHealth',1);info(app,TREASURE_NAME[3]+'触发,生命值+1!')}if(inventory.state.tre_bracelet){gp_store.commit('incGodsHand',1);info(app,TREASURE_NAME[1]+'触发,上帝之手能力+1!')}}function gobackDay(){if(gp_store.state.today==0)return error(app,'当前天数即将溢出:小于0');if(calendar[gp_store.state.today]==1)eventHappend();gp_store.commit('incToday',-1)}function safelyChangeDay(days){for(var i=0;i<Math.abs(days);i++){if(days>=0)nextDay();else gobackDay();if(gp_store.state.today>=gp_store.state.doomsdayBegin)gameEnd(false)}}function useGodsHand(){if(gp_store.state.godsHand<3)warning(app,'上帝之手能量不足');else{if(gp_store.state.doomsdayBegin==21){success(app,'你阻止了末日的到来！');gp_store.commit('incDoomsdayBegin',1);gp_store.commit('setEngineStarted',true);return gameEnd(true)}else{gp_store.commit('incDoomsdayBegin',1);gp_store.commit('incGodsHand',-3);success(app,'上帝之手使末日延迟1天到来!')}}}function consumeComponent(itemName){if(itemName==COMPONENT_NAME[0])return inventory.commit('incLead',-1);else if(itemName==COMPONENT_NAME[1])return inventory.commit('incSilica',-1);else if(itemName==COMPONENT_NAME[2])return inventory.commit('incWax',-1);else if(itemName==COMPONENT_NAME[3])return inventory.commit('incQuartz',-1);else if(itemName==COMPONENT_NAME[4])return inventory.commit('incSilver',-1);else if(itemName==COMPONENT_NAME[5])return inventory.commit('incGum',-1)}function startConstruct(itemName){gp_store.commit('viewConstruct/setChargingConstruct',itemName);gp_store.commit('setGamePhase',GAMEPHASE.START_CONSTRUCT);gameRouter.push('/main/workshop/construct/charge')}function connectConstruct(itemName){consumeComponent(itemName);gp_store.commit('viewConnect/setConnectingComponent',itemName);gp_store.commit('setGamePhase',GAMEPHASE.CONNECT_CONSTRUCT);gameRouter.push('/main/workshop/construct/connect')}function connectConstructDone(itemName){gp_store.dispatch('connectItem',itemName);}function isConstructOwned(itemName){if(itemName==CONSTRUCT_NAME[0])return inventory.state.con_battery;else if(itemName==CONSTRUCT_NAME[1])return inventory.state.con_chassis;else if(itemName==CONSTRUCT_NAME[2])return inventory.state.con_lens;else if(itemName==CONSTRUCT_NAME[3])return inventory.state.con_mirror;else if(itemName==CONSTRUCT_NAME[4])return inventory.state.con_seal;else if(itemName==CONSTRUCT_NAME[5])return inventory.state.con_gate}function isConstructCharged(itemName){if(itemName==CONSTRUCT_NAME[0])return gp_store.state.charge_con_battery;else if(itemName==CONSTRUCT_NAME[1])return gp_store.state.charge_con_chassis;else if(itemName==CONSTRUCT_NAME[2])return gp_store.state.charge_con_lens;else if(itemName==CONSTRUCT_NAME[3])return gp_store.state.charge_con_mirror;else if(itemName==CONSTRUCT_NAME[4])return gp_store.state.charge_con_seal;else if(itemName==CONSTRUCT_NAME[5])return gp_store.state.charge_con_gate}function isConponentConnected(itemName){if(itemName==COMPONENT_NAME[0])return gp_store.state.connect_battery_chassis_lead;else if(itemName==COMPONENT_NAME[1])return gp_store.state.connect_seal_mirror_silica;else if(itemName==COMPONENT_NAME[2])return gp_store.state.connect_gate_mirror_wax;else if(itemName==COMPONENT_NAME[3])return gp_store.state.connect_seal_quartz;else if(itemName==COMPONENT_NAME[4])return gp_store.state.connect_seal_lens_silver;else if(itemName==COMPONENT_NAME[5])return gp_store.state.connect_gate_chassis_gum}function getConstructDetail(itemName){if(itemName==CONSTRUCT_NAME[0])return CONSTRUCT_DETAIL[0];else if(itemName==CONSTRUCT_NAME[1])return CONSTRUCT_DETAIL[1];else if(itemName==CONSTRUCT_NAME[2])return CONSTRUCT_DETAIL[2];else if(itemName==CONSTRUCT_NAME[3])return CONSTRUCT_DETAIL[3];else if(itemName==CONSTRUCT_NAME[4])return CONSTRUCT_DETAIL[4];else if(itemName==CONSTRUCT_NAME[5])return CONSTRUCT_DETAIL[5]}function isTreasureOwned(itemName){if(itemName==TREASURE_NAME[0])return inventory.state.tre_plat;else if(itemName==TREASURE_NAME[1])return inventory.state.tre_bracelet;else if(itemName==TREASURE_NAME[2])return inventory.state.tre_moonlace;else if(itemName==TREASURE_NAME[3])return inventory.state.tre_scale;else if(itemName==TREASURE_NAME[4])return inventory.state.tre_shard;else if(itemName==TREASURE_NAME[5])return inventory.state.tre_record}function getTreasureDetail(itemName){if(itemName==TREASURE_NAME[0])return TREASURE_DETAIL[0];else if(itemName==TREASURE_NAME[1])return TREASURE_DETAIL[1];else if(itemName==TREASURE_NAME[2])return TREASURE_DETAIL[2];else if(itemName==TREASURE_NAME[3])return TREASURE_DETAIL[3];else if(itemName==TREASURE_NAME[4])return TREASURE_DETAIL[4];else if(itemName==TREASURE_NAME[5])return TREASURE_DETAIL[5]}function isToolCharged(toolName){if(toolName==TOOL_NAME[0]&&gp_store.state.tool_charm)return true;else if(toolName==TOOL_NAME[1]&&gp_store.state.tool_wand)return true;else if(toolName==TOOL_NAME[2]&&gp_store.state.tool_rod)return true;return false}function getToolDetail(toolName){if(toolName==TOOL_NAME[0])return TOOL_DETAIL[0];else if(toolName==TOOL_NAME[1])return TOOL_DETAIL[1];else if(toolName==TOOL_NAME[2])return TOOL_DETAIL[2];return'未知物品:'+toolName}function getComponentNum(itemName){if(itemName==COMPONENT_NAME[0])return inventory.state.com_lead;else if(itemName==COMPONENT_NAME[1])return inventory.state.com_silica;else if(itemName==COMPONENT_NAME[2])return inventory.state.com_wax;else if(itemName==COMPONENT_NAME[3])return inventory.state.com_quartz;else if(itemName==COMPONENT_NAME[4])return inventory.state.com_silver;else if(itemName==COMPONENT_NAME[5])return inventory.state.com_gum}function countConstrutSum(){var sum=0;if(inventory.state.con_battery)sum++;if(inventory.state.con_chassis)sum++;if(inventory.state.con_lens)sum++;if(inventory.state.con_mirror)sum++;if(inventory.state.con_seal)sum++;if(inventory.state.con_gate)sum++;return sum}function countStartedConstrutSum(){var sum=0;if(gp_store.state.charge_con_battery)sum++;if(gp_store.state.charge_con_chassis)sum++;if(gp_store.state.charge_con_lens)sum++;if(gp_store.state.charge_con_mirror)sum++;if(gp_store.state.charge_con_seal)sum++;if(gp_store.state.charge_con_gate)sum++;return sum}function countConnectedConstrutSum(){var sum=0;if(gp_store.state.connect_seal_lens_silver)sum++;if(gp_store.state.connect_seal_quartz)sum++;if(gp_store.state.connect_seal_mirror_silica)sum++;if(gp_store.state.connect_gate_mirror_wax)sum++;if(gp_store.state.connect_gate_chassis_gum)sum++;if(gp_store.state.connect_battery_chassis_lead)sum++;return sum}function countTreasureSum(){var sum=0;if(inventory.state.tre_plat)sum++;if(inventory.state.tre_bracelet)sum++;if(inventory.state.tre_moonlace)sum++;if(inventory.state.tre_scale)sum++;if(inventory.state.tre_shard)sum++;if(inventory.state.tre_record)sum++;return sum}function countUnuesdToolSum(){var sum=0;if(gp_store.state.tool_charm)sum++;if(gp_store.state.tool_wand)sum++;if(gp_store.state.tool_rod)sum++;return sum}function countScoreSum(){return 10*countConstrutSum()+5*countConnectedConstrutSum()+5*countConnectedConstrutSum()+10*countTreasureSum()+20*gp_store.state.perfectSearchSum+10*countUnuesdToolSum()+1*gp_store.state.health+50*Number(gp_store.state.engineStarted)+5*(gp_store.state.engineStarted?(gp_store.state.doomsdayBegin-gp_store.state.today):0)}function countConnectPoiontSum(){return gp_store.state.connectPoiontLead+gp_store.state.connectPoiontSilica+gp_store.state.connectPoiontWax+gp_store.state.connectPoiontQuartz+gp_store.state.connectPoiontSilver+gp_store.state.connectPoiontGum}function moveToBase(base,origin,adjust){let result=origin+adjust;if(Math.min(origin,result)<=base&&base<=Math.max(origin,result))return base;else return Math.abs(result-base)<Math.abs(origin-base)?result:origin}function info(app,msg){app.$Message.info({closable:true,render:h=>h('span',{style:{color:'#2db7f5'}},msg)})}function success(app,msg){app.$Message.success({closable:true,render:h=>h('span',{style:{color:'#19be6b'}},msg)})}function warning(app,msg){app.$Message.warning({closable:true,render:h=>h('span',{style:{color:'#ff9900'}},msg)})}function error(app,msg){app.$Message.error({closable:true,render:h=>h('span',{style:{color:'#ed4014'}},msg)})}var myAudio=new Audio();var playAudio=function(){var arr=cloneArray(audioList);arr.sort(()=>Math.random()>0.5?-1:1);myAudio.preload=true;myAudio.controls=true;myAudio.src=arr.pop();myAudio.addEventListener('ended',playEndedHandler,false);myAudio.play();myAudio.loop=false;function playEndedHandler(){myAudio.src=arr.pop();myAudio.play();if(gp_store.state.debug)console.log('Now Play Audio:'+myAudio.src);if(arr.length==0){arr=cloneArray(audioList);arr.sort(()=>Math.random()>0.5?-1:1)}}};function pauseAudio(){myAudio.pause()}function replayAudio(){myAudio.play()}function cloneArray(ary){let copy=[];for(var i of ary)copy.push(i);return copy}